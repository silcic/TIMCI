
```{r, include=params$log}
###
# study name: TIMCI
# program name: adh_dev.Rmd  
# program purpose: summary of intervention adherence and protocol deviations
# author: Silvia Cicconi  
# inputs: Datasets and codebooks  
# output(s): Datasets with additional derived variables 
# note: check git information for date, version and modification history
###
```

# Intervention adherence and protocol deviations

## Intervention adherence
This section only include data from the post-intervention period.

### Summary of pulse oximetry adherence

Pulse oximeter use was indicated for all infants under 2 months of age and all children 2-59 months in Kenya. In Senegal, indication was for all infants under 2 months of age and for children 2-59 months with cough/difficulty breathing or red/yellow IMCI classification. 
Pulse oximeter is considered used if the research assistant found in clinical records any SpO2 value (readable or unreadable).


```{r PULSE OXIMETER ADHERENCE}

#check codebooks for pulse ox reading
d0_cb_ke[which(d0_cb_ke$db_name=="spo2"), c("db_name", "label", "value", "category")]
d0_cb_se[which(d0_cb_se$name=="spo2"), c("name", "label", "values")]

##from pulse oximetry measures
d0$pulse_ox_spo2 <- 0
d0$pulse_ox_spo2[which(d0$spo2%in%c(1,2))] <- 1
d0$pulse_ox_spo2 <- factor(d0$pulse_ox_spo2)

#overall indication
pulse_ox_adh_ov <- sum.tab(d0[which(d0$pulse_ox_ind==1),], "pulse_ox_spo2", "pre_post")

pulse_ox_adh_ov[which(pulse_ox_adh_ov$`Pre-intervention`!=""), "Pre-intervention"] <- "-" #replace "-" for pre-intervention


```

```{r, results='asis'}

knitr::kable(pulse_ox_adh_ov , row.names = F) 

```

For older children in Senegal, adherence evaluation is based on indication defined from caregivers reported cough/difficulty breathing or indication defined from IMCI classification. The table below summarises adherence separately, on the basis of the two definitions.

### Summary of pulse oximetry adherence for children 2-59 months of age in Senegal

```{r PULSE OXIMETER ADHERENCE SENEGAL OLDER CHILDREN}

#indicated as per caregivers reported cough/difficulty breathing 
pulse_ox_adh_cg <- onerow.sum.tab(d0[which(d0$pulse_ox_ind_cg==1 & d0$yg_infant==0),], "pulse_ox_spo2", "Pulse oximetry adherence (indicated as per caregivers reported cough/difficulty breathing)", "pre_post")
#indicated as per caregivers reported cough/difficulty breathing 
pulse_ox_adh_imci <- onerow.sum.tab(d0[which(d0$pulse_ox_ind_imci==1 & d0$yg_infant==0),], "pulse_ox_spo2", "Pulse oximetry adherence (indicated as per IMCI classification)", "pre_post")


##combine table
pulse_ox_adh1 <- rbind(pulse_ox_adh_cg, pulse_ox_adh_imci)
pulse_ox_adh1[which(pulse_ox_adh1$`Pre-intervention`!=""), "Pre-intervention"] <- "-" #replace "-" for pre-intervention

##Keep only Senegal
pulse_ox_adh1 <- pulse_ox_adh1[which(!pulse_ox_adh1[,1]%in%c("Combined", "Kenya")),]


```

```{r, results='asis'}

knitr::kable(pulse_ox_adh1, row.names = F) 

```


### Summary of pulse oximetry adherence weekly and by facility

Note that graphs are based on overall pulse oximeter indication (from either caregiver reported cough/difficulty breathing or IMCI classification).

```{r GRAPHS WEEKLY PULSE OXIMETER ADHERENCE, fig.height = 12, fig.width = 9}

##sequence of dates indicating the start of each week
fid_list <- c(fac_ke$fid, fac_se$fid); fid_list_names <- c(paste(fac_ke$facility_name, " - ", fac_ke$lvl2, sep=""), paste(fac_se$facility_name, " - ", fac_se$lvl2, sep=""))
d0$week <- NA
pseudo.dt_post <- list()

for(i in 1:length(fid_list)){
  
  #post-intervention only
  pseudo.dt_post[[i]] <- seq(unique(pmax(d0$Date.trained.HCP.returned.at.the.facility[which(d0$fid==fid_list[i])], d0$Date.of.devices.being.provided.to.the.trained.HCP[which(d0$fid==fid_list[i])])), max(d0$date_visit[which(d0$pre_post==1 & d0$fid==fid_list[i])]), 7)
  
    for(j in 1:(length(pseudo.dt_post[[i]])-1)){d0$week[which(d0$date_visit>=pseudo.dt_post[[i]][j] & d0$date_visit<pseudo.dt_post[[i]][j+1] & d0$fid==fid_list[i])] <- j}; d0$week[which(d0$date_visit>=pseudo.dt_post[[i]][length(pseudo.dt_post[[i]])] & d0$fid==fid_list[i])] <- length(pseudo.dt_post[[i]])
  
}


#save graph per each facility
for(i in 1:length(fid_list)){ 
  assign(paste("gr", i, sep=""), bar_graph_perc(d0[which(d0$pre_post==1 & d0$fid==fid_list[i]),], "pulse_ox_spo2", fid_list[i], fid_list_names[i], pseudo.dt_post[[i]]))
}



#split for country and 6 per page
nrow(fac_ke); nrow(fac_se)
grid.arrange(gr1, gr2, gr3, gr4, gr5, ncol=1, top="Kenya")
grid.arrange(gr6, gr7, gr8, gr9, gr10, ncol=1, top="Kenya")
grid.arrange(gr11, gr12, gr13, gr14, gr15, ncol=1, top="Kenya")
grid.arrange(gr16, gr17, gr18, gr19, ncol=1, top="Kenya")
grid.arrange(gr20, gr21, gr22, gr23, gr24,  ncol=1, top="Senegal")
grid.arrange(gr25, gr26, gr27, gr28, gr29,  ncol=1, top="Senegal")
grid.arrange(gr30, gr31, gr32, gr33, gr34, ncol=1, top="Senegal")
grid.arrange(gr35, gr36, gr37, gr38, gr39, ncol=1, top="Senegal")

```

### Summary of CDSA adherence

CDSA was indicated for all young infants and older children in both countries. CDSA adherence is evaluated comparing the number of children enrolled and the number of records in the CDSA database.

```{r CDSA ADHERENCE}

##children enrolled in d0
enrol_d0 <- c(nrow(d0), nrow(d0[which(d0$country=="ke"),]), nrow(d0[which(d0$country=="se"),]))

##children enrolled in CDSA
enrol_cdsa <- c(nrow(cdsa), nrow(cdsa[which(cdsa$country=="ke"),]), nrow(cdsa[which(cdsa$country=="se"),]))

##combine
cdsa_adh <- as.data.frame(cbind(c("Combined", "Kenya", "Senegal"), enrol_d0, enrol_cdsa, paste(round(enrol_cdsa/enrol_d0*100,1), "%", sep="")))
names(cdsa_adh) <- c("", "Children enrolled", "Children recorded in CDSA", "Children recorded in CDSA/children enrolled")


```

```{r, results='asis'}

knitr::kable(cdsa_adh, row.names = F) 

```


### Summary of CDSA adherence weekly and by facility

```{r GRAPHS WEEKLY CDSA ADHERENCE, fig.height = 12, fig.width = 9}

##sequence of dates indicating the start of each week
cdsa$week <- NA

for(i in 1:length(fid_list)){
    for(j in 1:(length(pseudo.dt_post[[i]])-1)){cdsa$week[which(cdsa$date_visit>=pseudo.dt_post[[i]][j] & cdsa$date_visit<pseudo.dt_post[[i]][j+1] & cdsa$fid==fid_list[i])] <- j}; cdsa$week[which(cdsa$date_visit>=pseudo.dt_post[[i]][length(pseudo.dt_post[[i]])] & cdsa$fid==fid_list[i])] <- length(pseudo.dt_post[[i]])
}


#save graph per each facility
for(i in 1:length(fid_list)){ 
  assign(paste("gr", i, sep=""), bar_graph_2b(d0[which(d0$pre_post==1 & d0$fid==fid_list[i]),], cdsa[which(cdsa$fid==fid_list[i]),], fid_list[i], fid_list_names[i], pseudo.dt_post[[i]]))
}

##dummy graph for legend
gr0 <- gr1 + scale_fill_discrete(name = "", labels = c("Children enrolled","Children recorded in CDSA")) + theme(legend.position = "bottom", legend.key.size = unit(0.2, "cm"))

legend <- get_legend(gr0)


#split for country and 6 per page
nrow(fac_ke); nrow(fac_se)
grid.arrange(gr1, gr2, gr3, gr4, gr5, ncol=1, top="Kenya", legend)
grid.arrange(gr6, gr7, gr8, gr9, gr10, ncol=1, top="Kenya", legend)
grid.arrange(gr11, gr12, gr13, gr14, gr15, ncol=1, top="Kenya", legend)
grid.arrange(gr16, gr17, gr18, gr19, ncol=1, top="Kenya", legend)
grid.arrange(gr20, gr21, gr22, gr23, gr24,  ncol=1, top="Senegal", legend)
grid.arrange(gr25, gr26, gr27, gr28, gr29,  ncol=1, top="Senegal", legend)
grid.arrange(gr30, gr31, gr32, gr33, gr34, ncol=1, top="Senegal", legend)
grid.arrange(gr35, gr36, gr37, gr38, gr39, ncol=1, top="Senegal", legend)

```

## Protocol deviations

Protocol deviations are evaluated in terms of follow-up not attempted when expected to be conducted (after 7 days of day 0, for all children except withdrawals occurring before day 7). Attempts performed more than 30 days of day 0 are not considered valid, as they are excluded from the analysis (see SAP Section 6.1.1).

```{r PROTOCOL DEVIATIONS}

#table
tab_prot_dev <- sum.tab(d0[-which(d0$wth_flag_d7==1),], "no_att_fu_flag", "pre_post")


```

```{r, results='asis'}

knitr::kable(tab_prot_dev, row.names = F) 

```


